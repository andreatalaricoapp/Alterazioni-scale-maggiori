<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trainer Scale Maggiori</title>
  <style>
    :root { --bg:#0b0c10; --panel:#11131a; --muted:#9aa0aa; --text:#f2f5f7; --ok:#16a34a; --err:#ef4444; }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0c10 0%,#121420 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .card{background:var(--panel);border:1px solid #23283a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid #1d2130}
    h1{font-size:20px;margin:0}
    .content{padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:#243046;color:#fff;border:1px solid #32415f;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#1c2436}
    .pill{padding:6px 10px;border-radius:999px;background:#1b2636;color:#c9d5e8;border:1px solid #2b3b57;font-size:13px}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#9aa6b2}
    .knum{width:56px;text-align:center;border-radius:10px;border:1px solid #2b3b57;background:#1b2636;color:#c9d5e8;padding:6px}

    /* piano */
    .piano { display:flex; user-select:none; -webkit-user-select:none; }
    .wkey { position:relative; width:44px; height:140px; background:#fafafa; border:1px solid #bfc7d0; border-top:0; border-radius:0 0 4px 4px; }
    .wkey:active{ background:#eef2f7 }
    .wlabel { position:absolute; bottom:6px; left:0; right:0; text-align:center; font-size:11px; color:#4b5563; pointer-events:none; }

    .bkey { position:absolute; top:0; right:-12px; width:26px; height:86px; background:#0b0b0f; border:1px solid #1a1a22; border-radius:0 0 4px 4px;
            box-shadow:inset 0 0 12px rgba(255,255,255,0.07); z-index:3; pointer-events:auto; }
    .bkey:active{ filter:brightness(1.25) }
    .blabel { position:absolute; bottom:6px; left:0; right:0; text-align:center; font-size:10px; color:#e5e7eb; pointer-events:none; }

    /* feedback */
    .key{transition:transform .06s ease, background-color .12s ease}
    .key:active{transform:translateY(1px)}
    .ok-flash{background:var(--ok) !important;color:#fff !important}
    .bad-flash{background:var(--err) !important;color:#fff !important}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React (UMD) + Babel (solo per comodità del JSX; per massime performance si può rimuovere facendo build) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    /* ---------- DATI: scale maggiori ---------- */
    const MAJOR_SCALES = {
      C:  ["C","D","E","F","G","A","B","C"],
      G:  ["G","A","B","C","D","E","F#","G"],
      D:  ["D","E","F#","G","A","B","C#","D"],
      A:  ["A","B","C#","D","E","F#","G#","A"],
      E:  ["E","F#","G#","A","B","C#","D#","E"],
      B:  ["B","C#","D#","E","F#","G#","A#","B"],
      "F#":["F#","G#","A#","B","C#","D#","E#","F#"],
      "C#":["C#","D#","E#","F#","G#","A#","B#","C#"],

      F:  ["F","G","A","Bb","C","D","E","F"],
      Bb: ["Bb","C","D","Eb","F","G","A","Bb"],
      Eb: ["Eb","F","G","Ab","Bb","C","D","Eb"],
      Ab: ["Ab","Bb","C","Db","Eb","F","G","Ab"],
      Db: ["Db","Eb","F","Gb","Ab","Bb","C","Db"],
      Gb: ["Gb","Ab","Bb","Cb","Db","Eb","F","Gb"],
      Cb: ["Cb","Db","Eb","Fb","Gb","Ab","Bb","Cb"],
    };

    const ALL_KEYS_SHARPS = ["G","D","A","E","B","F#","C#"];
    const ALL_KEYS_FLATS  = ["F","Bb","Eb","Ab","Db","Gb","Cb"];
    const ALL_KEYS_MIXED  = ["C", ...ALL_KEYS_SHARPS, ...ALL_KEYS_FLATS];

    /* ---------- HELPERS ---------- */
    const descending = (asc)=>[...asc].reverse();
    const norm = (s)=>s.replace(/[0-9]/g,"").replace("♯","#").replace("♭","b");

    // ENARMONIA: confronto per pitch class
    const LETTER_PC = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
    function pitchClass(name){
      const s = norm(name);
      const base = LETTER_PC[s[0]] ?? 0;
      let acc = 0;
      for(let i=1;i<s.length;i++){
        if(s[i]==="#") acc += 1; else if(s[i]==="b") acc -= 1;
      }
      return ((base + acc) % 12 + 12) % 12;
    }
    function samePitch(a,b){ return pitchClass(a) === pitchClass(b); }

    /* ---------- PIANO ---------- */
    const WHITE = ["C","D","E","F","G","A","B"];
    const HAS_BLACK_AFTER = new Set(["C","D","F","G","A"]);
    const BLACK_FOR_AFTER = {
      C: { sharp:"C#", flat:"Db" },
      D: { sharp:"D#", flat:"Eb" },
      F: { sharp:"F#", flat:"Gb" },
      G: { sharp:"G#", flat:"Ab" },
      A: { sharp:"A#", flat:"Bb" },
    };

    function Piano({ onNote, accidentalPref, showLabels, numOctaves=1 }) {
      const startOct = 4;
      const octaves = Array.from({length:numOctaves}, (_,i)=>startOct+i);
      return (
        <div className="piano" role="group" aria-label="Pianoforte">
          {octaves.map((oct)=>(
            <div key={oct} style={{display:"flex"}}>
              {WHITE.map((wn)=>(
                <div key={wn+oct} className="wkey-wrap" style={{position:"relative"}}>
                  <button
                    className="wkey key"
                    onClick={()=>onNote(wn)}
                    title={`${wn}${oct}`}
                    aria-label={`${wn} ${oct}`}
                  >
                    {showLabels && <span className="wlabel">{wn}</span>}
                  </button>

                  {HAS_BLACK_AFTER.has(wn) && (
                    <button
                      className="bkey key"
                      onClick={()=>{
                        const lbl = accidentalPref==="flat"
                          ? BLACK_FOR_AFTER[wn].flat
                          : BLACK_FOR_AFTER[wn].sharp;
                        onNote(lbl);
                      }}
                      title={`${accidentalPref==="flat" ? BLACK_FOR_AFTER[wn].flat : BLACK_FOR_AFTER[wn].sharp}${oct}`}
                      aria-label={`${accidentalPref==="flat" ? BLACK_FOR_AFTER[wn].flat : BLACK_FOR_AFTER[wn].sharp} ${oct}`}
                    >
                      {showLabels && (
                        <span className="blabel">
                          {accidentalPref==="flat" ? BLACK_FOR_AFTER[wn].flat : BLACK_FOR_AFTER[wn].sharp}
                        </span>
                      )}
                    </button>
                  )}
                </div>
              ))}
            </div>
          ))}
        </div>
      );
    }

    /* ---------- APP ---------- */
    function App(){
      const [mode,setMode]=useState("diesis");     // diesis | bemolle | entrambe
      const [showLabels,setShowLabels]=useState(true);
      const [numOctaves,setNumOctaves]=useState(1);

      const [currentKey,setCurrentKey]=useState(null);
      const [expectedAsc,setExpectedAsc]=useState([]);
      const [expectedDisc,setExpectedDisc]=useState([]);
      const [phase,setPhase]=useState("idle"); // idle | asc | disc
      const [inputAsc,setInputAsc]=useState([]);
      const [inputDisc,setInputDisc]=useState([]);

      const [errors,setErrors]=useState(0);
      const [streak,setStreak]=useState(0);
      const [flash,setFlash]=useState({ note:null, ok:null, ts:0 });

      const [timed,setTimed]=useState(false);
      const [secondsPerNote,setSecondsPerNote]=useState(3);
      const [timeLeft,setTimeLeft]=useState(0);
      const timerRef = useRef(null);

      const keyPool = useMemo(()=>{
        if (mode==="diesis") return ALL_KEYS_SHARPS;
        if (mode==="bemolle") return ALL_KEYS_FLATS;
        return ALL_KEYS_MIXED;
      },[mode]);

      const accidentalPref = useMemo(()=> (mode==="bemolle" ? "flat" : "sharp"), [mode]);

      const nextExpected = useMemo(()=>{
        if (phase==="asc")  return expectedAsc[inputAsc.length];
        if (phase==="disc") return expectedDisc[inputDisc.length];
        return null;
      },[phase, expectedAsc, expectedDisc, inputAsc, inputDisc]);

      // timer per nota
      useEffect(()=>{
        if (!timed || !nextExpected) { clearInterval(timerRef.current); setTimeLeft(0); return; }
        clearInterval(timerRef.current);
        setTimeLeft(secondsPerNote);
        timerRef.current = setInterval(()=>{
          setTimeLeft(t=>{
            if (t<=1){
              clearInterval(timerRef.current);
              setErrors(e=>e+1);
              setFlash({ note: norm(nextExpected), ok:false, ts: Date.now() });
              // riavvia per la stessa nota
              setTimeout(()=>{
                if (timed && nextExpected){
                  setTimeLeft(secondsPerNote);
                  timerRef.current = setInterval(()=>setTimeLeft(x=>x<=1? (clearInterval(timerRef.current),0) : x-1), 1000);
                }
              }, 120);
              return 0;
            }
            return t-1;
          });
        }, 1000);
        return ()=>clearInterval(timerRef.current);
      },[timed, secondsPerNote, nextExpected]);

      function generateScale(){
        const randKey = keyPool[Math.floor(Math.random()*keyPool.length)];
        const asc = MAJOR_SCALES[randKey] || MAJOR_SCALES["C"];
        const disc = descending(asc);
        setCurrentKey(randKey);
        setExpectedAsc(asc);
        setExpectedDisc(disc);
        setInputAsc([]); setInputDisc([]);
        setErrors(0);
        setPhase("asc");
      }

      function resetCurrent(){
        setInputAsc([]); setInputDisc([]);
        setErrors(0);
        setPhase(currentKey? "asc":"idle");
        setFlash({ note:null, ok:null, ts:0 });
      }

      function undoLast(){
        if (phase==="disc" && inputDisc.length){
          setInputDisc(p=>p.slice(0,-1));
          setFlash({ note:null, ok:null, ts:Date.now() });
          return;
        }
        if (phase==="asc" && inputAsc.length){
          setInputAsc(p=>p.slice(0,-1));
          setFlash({ note:null, ok:null, ts:Date.now() });
        }
      }

      function onKeyClick(note){
        const clickedClean = norm(note);                 // es. "F"
        const expectedRaw = nextExpected || null;        // es. "E#"
        const expectedClean = expectedRaw ? norm(expectedRaw) : null;

        // ok se grafia identica o stessa pitch class
        const ok = expectedClean && (clickedClean === expectedClean || samePitch(clickedClean, expectedClean));

        setFlash({ note: clickedClean, ok, ts: Date.now() });
        if (!ok){ setErrors(e=>e+1); return; }

        // salva la GRAFIA ATTESA (così “Inserite” mostra E#, Fb, ecc.)
        const labelToStore = expectedRaw;

        if (phase==="asc"){
          if (inputAsc.length < 8) setInputAsc(p=>[...p, labelToStore]);
          if (inputAsc.length + 1 === 8) setPhase("disc");
        } else if (phase==="disc"){
          if (inputDisc.length < 8) setInputDisc(p=>[...p, labelToStore]);
          if (inputDisc.length + 1 === 8){
            setStreak(s=>s+1);
            setTimeout(()=>generateScale(), 600); // allenamento continuo
          }
        }
      }

      return (
        <div className="wrap">
          <div className="card">
            <div className="hdr">
              <h1>Trainer Scale Maggiori</h1>
              <div className="row">
                <button className="btn" onClick={generateScale}>Nuova scala</button>
                <button className="btn secondary" onClick={resetCurrent}>Reset</button>
                <button className="btn secondary" onClick={undoLast}>Annulla ultimo</button>
              </div>
            </div>

            <div className="content">
              {/* impostazioni */}
              <div className="row" style={{marginBottom:8}}>
                <div className="pill">
                  Modalità:{" "}
                  <select value={mode} onChange={e=>setMode(e.target.value)} style={{background:"transparent", color:"#e5e7eb", border:"none"}}>
                    <option value="diesis">Diesis</option>
                    <option value="bemolle">Bemolle</option>
                    <option value="entrambe">Entrambe</option>
                  </select>
                </div>

                <label className="pill" style={{display:"flex", gap:8, alignItems:"center"}}>
                  <input type="checkbox" checked={showLabels} onChange={e=>setShowLabels(e.target.checked)} />
                  Mostra nomi note
                </label>

                <div className="pill" style={{display:"flex", gap:8, alignItems:"center"}}>
                  Ottave:
                  <select value={numOctaves} onChange={e=>setNumOctaves(Number(e.target.value))} style={{background:"transparent", color:"#e5e7eb", border:"none"}}>
                    <option value="1">1</option>
                    <option value="2">2</option>
                  </select>
                </div>

                <label className="pill" style={{display:"flex", gap:8, alignItems:"center"}}>
                  <input type="checkbox" checked={timed} onChange={e=>setTimed(e.target.checked)} />
                  A tempo
                </label>
                <div className="pill" style={{display:"flex", gap:8, alignItems:"center"}}>
                  sec/nota:
                  <input className="knum" value={secondsPerNote}
                         onChange={e=>setSecondsPerNote(Math.max(1, Math.min(20, Number(e.target.value)||1)))}/>
                </div>
              </div>

              {/* stato */}
              <div className="row" style={{marginBottom:6}}>
                <div className="pill">Scala: <b>{currentKey ?? "—"} maggiore</b></div>
                <div className="pill">Fase: {phase==="asc"?"Ascendente":phase==="disc"?"Discendente":"—"}</div>
                <div className="pill">Errori: {errors}</div>
                <div className="pill">Streak: {streak}</div>
                {timed && nextExpected && <div className="pill">Tempo: {timeLeft}s</div>}
              </div>

              {/* tastiera */}
              <div style={{marginTop:10}}>
                <Piano
                  onNote={onKeyClick}
                  accidentalPref={accidentalPref}
                  showLabels={showLabels}
                  numOctaves={numOctaves}
                />
              </div>

              {/* progressi */}
              <div className="hint" style={{marginTop:8}}>
                Progressi — Asc: {inputAsc.length}/8 · Disc: {inputDisc.length}/8
              </div>

              {/* attese / inserite */}
              <div style={{marginTop:14}}>
                <div className="muted">Attese: asc <b>{expectedAsc.join(" ")||"—"}</b> · disc <b>{expectedDisc.join(" ")||"—"}</b></div>
                <div className="muted">Inserite: asc <b>{inputAsc.join(" ")||"—"}</b> · disc <b>{inputDisc.join(" ")||"—"}</b></div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>